<!DOCTYPE html>
<html>
  <head>
    <script src="jquery.js"></script>
    <script src="data_generator.js"></script>
    <style>
      #container {
        width: 800px;
        margin: 10px auto;
      }
      h1 {
        font-family: "Trebuchet MS";
      }
      .tweet {
        border-bottom: 1px solid lightgrey;
        padding: 8px 0;
        position: relative;
        font-family: verdana;
        font-size: .7em;
      }
      .a, a:active, a:hover, a:visited {
        color: darkgreen;
      }
      .user {
        display: inline-block;
        width: 150px;
      }
      .message {
        display: inline-block;
      }
      .timestamp {
        display: inline-block;
        float: right;
      }

    </style>
  </head>
  <body>
    <div id="container">


      <div class="tweet">
        <div class="user">@user</div>
        <div class="message">message</div>
        <div class="timestamp">timestamp</div>
      </div>

    <script>


      $(document).ready(function(){
        var $container = $('#container');
        var refreshInterval = 1500;

        var displayAllTweets = function() {
          var index = streams.home.length - 1;
          $("#container").html('<h1>Twittler: Home (' + index + ' tweets)</h1>');
            
            while(index >= 0) {
              var tweet = streams.home[index];
              
              var timeOfTweet = new Date(tweet.created_at).getTime()/1000; // in sec
              var timeNow = new Date().getTime()/1000; // in sec
              var timeDiffSec = (timeNow - timeOfTweet).toFixed(); // in sec

              var $tweet = $('<div class="tweet"></div>');
              var $user = $('<a href="#" class="user" data-user="'+ tweet.user +'"><div></div></a>');
              //var $user = $('<div class="user"><a href="#"></a></div>'); // no link; why?
              var $message = $('<div class="message"></div>');
              var $created = $('<div class="timestamp"></div>');

              $user.text('@' + tweet.user);
              $message.text(tweet.message);
              $created.text(timeDiffSec + " sec");
              $tweet.append($user, $message, $created);
              $tweet.appendTo($container);
              index -= 1;
            }
        }
        
        /* display a user's timeline: */
        var displayTimeline = function(userName) {
          //console.log(streams.users[userName]);
          var userStream = streams.users[userName];
          console.log(userStream);
          //console.log(streams.users.userName); // 'undefined': why?

          var index = userStream.length - 1;
          $("#container").html('<h1>Twittler: ' + userName + ' (' + index + ' tweets)</h1>');
          while(index >= 0) {
              var tweet = userStream[index];
              
              var timeOfTweet = new Date(tweet.created_at).getTime()/1000; // in sec
              var timeNow = new Date().getTime()/1000; // in sec
              var timeDiffSec = (timeNow - timeOfTweet).toFixed(); // in sec

              var $tweet = $('<div class="tweet"></div>');
              var $user = $('<a href="#" class="user" data-user="'+ tweet.user +'"><div></div></a>');
              //var $user = $('<div class="user"><a href="#"></a></div>'); // no link; why?
              var $message = $('<div class="message"></div>');
              var $created = $('<div class="timestamp"></div>');

              $user.text('@' + tweet.user);
              $message.text(tweet.message);
              $created.text(timeDiffSec + " sec");
              $tweet.append($user, $message, $created);
              $tweet.appendTo($container);
              index -= 1;
            }
        }
        
        // show all tweets and refresh on intervals
        displayAllTweets();
        setInterval(displayAllTweets, refreshInterval);

        // when a username is clicked, load & display that user's timeline:
        $("#container").on('click', '.user', function() {
          var user = $(".user").data("user");
          //console.log(user);
          displayTimeline(user);
        });

        /*
        $("#container").on('click', '.user', function() { // works
        //$(".tweet").on('click', 'a', function() { // fails: only works on 1st click?
          console.log("clicked on user!" + Math.random());
        });
        */



        });
      

    </script>
  </div>
  </body>
</html>
